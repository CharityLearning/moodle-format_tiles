define(["jquery","core/ajax","core/templates","core/notification","core/str","core/url"],function(a,b,c,d,e,f){"use strict";var g={},h=a("html,body"),i=a("#page"),j={MENU_ACTION:".menu-action-text",SUBTILE:".subtile",SPACER:".spacer",AVAIL_INFO:".availabilityinfo",ACTIVITY_INSTANCE:".subtile-activityinstance",INSTANCE_NAME:".instancename",SECTION_CM_EDIT_ACTIONS:".section-cm-edit-actions",EDITING_MOVE:".editing_move",LABEL_CONVERT:".editing_labelconvert",CM_EDIT_ACTION:".cm-edit-action",ACTIVITY_ICON:".activityicon",EDITING_DELETE:".editing_delete"},k={SHOW:"show",HIDE:"hide",FA_EYE_SLASH:"fa-eye-slash",FA_EYE:"fa-eye",DIMMED:"dimmed",EDITING:"editing_",ACTIVITY:"activity",LABEL:"label"},l={CLICK:"click",MODULE_ADDED:"filter-content-updated"},m=function(c){var d,e=a(c.currentTarget);if("tiles-hide"===e.attr("data-action")?d={changeTo:k.HIDE,old:k.SHOW}:"tiles-show"===e.attr("data-action")&&(d={changeTo:k.SHOW,old:k.HIDE}),d){c.preventDefault(),e.attr("data-action","tiles-"+d.old);var f=b.call([{methodname:"core_course_edit_module",args:{id:e.attr("data-cmid"),action:d.changeTo}}],!0);f[0].done(function(b){e.removeClass(k.EDITING+d.old).addClass(k.EDITING+d.changeTo),e.attr("href",e.attr("href").replace("&"+d.old+"=","&"+d.changeTo+"="));var c=e.find(j.MENU_ACTION),f=e.closest(j.SUBTILE);d.changeTo===k.SHOW?(c.html(c.html().replace(g.show,g.hide)),e.find("i").removeClass(k.FA_EYE_SLASH).addClass(k.FA_EYE),f.removeClass(k.DIMMED)):d.changeTo===k.HIDE&&(c.html(c.html().replace(g.hide,g.show)),e.find("i").removeClass(k.FA_EYE).addClass(k.FA_EYE_SLASH),f.addClass(k.DIMMED));var h=a(b).find(j.AVAIL_INFO),i=f.find(j.AVAIL_INFO);h?i.length?i.replaceWith(h):h.appendTo(f.find(j.ACTIVITY_INSTANCE)):i.hide()}),f[0].fail(function(){window.location.replace(e.attr("href"))})}},n=function(a){var b={powerpoint:"ppt",document:"doc",spreadsheet:"xls",archive:"zip",pdf:"pdf",mp3:"mp3",mpeg:"mp4",jpeg:"jpeg",text:"txt",html:"html"};return b[a.split("/").slice(-1)[0].split("-")[0]]},o=function(a,b,c){void 0!==c&&""!==c||(c=g.other);var d={cmid:a.attr("id").split("-").slice(-1)[0],modtitle:a.find(j.INSTANCE_NAME).html().split("<")[0],cmeditmenu:a.find(j.SECTION_CM_EDIT_ACTIONS).html().replace(/\n/g,""),cmmove:a.find(j.EDITING_MOVE).html().replace(/\n/g,""),modname:"resource",modResourceType:b,modnameDisplay:c,useSubtiles:1,isEmbeddedResource:0,clickable:1,isediting:1};return d.isPdf="pdf"===d.modResourceType,d};return{init:function(b){a(document).ready(function(){if(Y.use("moodle-course-coursebase",function(){"undefined"!=typeof M.course&&setTimeout(function(){M.course.coursebase.registermodules=[]},500)}),a(j.LABEL_CONVERT).on(l.CLICK,function(b){b.preventDefault(),d.confirm(g.areyousure,g.converttopage_confirm,g.yes,g.no,function(){window.location=a(b.currentTarget).attr("href")},null)}),0!==b){var p=a("#module-"+b);h.animate({scrollTop:p.offset().top-130},"fast");for(var q=0;q<3;q++)p.fadeOut(300).fadeIn(300)}a(j.CM_EDIT_ACTION).click(function(a){m(a)}),a(document).on(l.MODULE_ADDED,function(b,d){var i=a("#"+a(d).attr("id"));if(i.hasClass(k.ACTIVITY)&&i.closest("ul").hasClass("subtiles")){i.children().hide(),i.append(a("<img/>").attr("src",f.imageUrl("loading","format_tiles")).addClass("loading-subtile").attr("title",g.loading));var l=i.prevAll(j.SUBTILE).not(j.SPACER).first();i.prevUntil(l,j.SPACER).hide();var m=n(i.find(j.ACTIVITY_ICON).attr("src")),p="displaytitle_mod_"+m;void 0===g[p]?e.get_string(p,"format_tiles").done(function(b){"[["!==b.substring(0,2)?g[p]=b:b="",c.render("format_tiles/course_module",o(i,m,b)).done(function(b){i.replaceWith(b);var c=a("#"+a(d).attr("id"));h.animate({scrollTop:c.offset().top-130},"fast");for(var e=0;e<3;e++)c.fadeOut(300).fadeIn(300)})}):c.render("format_tiles/course_module",o(i,m,g[p])).done(function(a){i.replaceWith(a)})}else i.find("div.mod-indent-outer").css("position","absolute").css("top","0").css("width","100%").css("padding-left","0")}),i.on(l.CLICK,j.EDITING_DELETE,function(b){var c=a(b.currentTarget).closest("li"+k.ACTIVITY),d=c.prevAll(j.SUBTILE).not(j.SPACER).first();c.hasClass(k.LABEL)&&c.prevUntil(d,j.SPACER).hide()}),e.get_strings([{key:"yes"},{key:"no"},{key:"show"},{key:"hide"},{key:"converttopage_confirm",component:"format_tiles"},{key:"areyousure"},{key:"complete",component:"format_tiles"},{key:"fileaddedtobottom",component:"format_tiles"},{key:"loading",component:"format_tiles"}]).done(function(a){g={yes:a[0],no:a[1],show:a[2],hide:a[3],converttopage_confirm:a[4],areyousure:a[5],complete:a[6],fileaddedtobottom:a[7],loading:a[8]}})})}}});