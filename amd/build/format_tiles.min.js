define(["jquery","core/templates","core/ajax","format_tiles/browser_storage","core/notification","core/str","core/config"],function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n=a("body"),o=a("body, html"),p=!1,q=!1,r=!1,s=60,t="0",u=0,v={PAGE:"#page",TILE:".tile",TILEID:"#tile-",MOVEABLE_SECTION:".moveablesection",FILTER_BUTTON:".filterbutton",TILE_LOADING_ICON:".tile-loading-icon",TILE_LOADING_ICON_ID:"#loading-icon-",TILE_COLLAPSED:".tile-collapsed",TILE_CLICKABLE:".tile-clickable",TILES:"ul.tiles",ACTIVITY:".activity",SPACER:".spacer",SECTION_MOVEABLE:".moveablesection",SECTION_ID:"#section-",SECTION_TITLE:".sectiontitle",SECTION_MAIN:".section.main",SECTION_BUTTONS:"#sectionbuttons",CLOSE_SEC_BTN:".closesectionbtn",HIDE_SEC0_BTN:"#buttonhidesec0",SECTION_ZERO:"#section-0",MOODLE_VIDEO:".mediaplugin.mediaplugin_videojs",LAUNCH_STANDARD:'[data-action="launch-tiles-standard"]',HEADER_BAR:["header.navbar","nav.fixed-top.navbar","#essentialnavbar.navbar","#navwrap","nav.navbar-fixed-top"],URLACTIVITYPOPUPLINK:".activity.modtype_url.urlpopup a"},w={SELECTED:"selected",HEADER_OVERLAY:"header-overlay",OPEN:"open",CLOSED:"closed",LAUNCH_CM_MODAL:"launch-tiles-cm-modal",STATE_VISIBLE:"state-visible"},x={CLICK:"click",KEYDOWN:"keydown",SCROLL:"scroll"},y={DISPLAY:"display",Z_INDEX:"z-index",HEIGHT:"height",BG_COLOUR:"background-color"},z={ESCAPE:27,TAB:9,RETURN:13},A=function(a){return void 0!==m&&(a===!0?m.fadeIn(300):m.fadeOut(300),!0)},B=function(b){var c=a(v.SECTION_ID+b);c.find("iframe").each(function(b,c){c=a(c),c.attr("src",c.attr("src"))})},C=function(b){a(v.MOVEABLE_SECTION).each(function(b,c){c=a(c),c.is(":visible")&&(B(c.attr("data-section")),c.slideUp().removeClass(w.STATE_VISIBLE))}),a(v.TILE).removeClass(w.SELECTED).css(y.Z_INDEX,"").css(y.BG_COLOUR,""),a(".section "+w.SELECTED).removeClass(w.SELECTED).css(y.Z_INDEX,""),l.fadeOut(300),A(!1),void 0!==b&&0!==b&&a(v.TILEID+b).focus(),a(v.TILE_LOADING_ICON).fadeOut(300,function(){a(v.TILE_LOADING_ICON).html("")}),r=!1},D=function(){var b,c,d=[];return a(v.TILES).children(v.TILE).not(a(v.TILE_COLLAPSED)).each(function(e,f){b=a(f).attr("data-section");var g=100;b&&(0===e?d[0]={displayAfterTile:"",sections:[b]}:Math.abs(a(f).position().top-a(c).position().top)<=g?d[d.length-1].sections.push(b):d.push({displayAfterTile:"",sections:[b]}),c=f,d[d.length-1].displayAfterTile=b)}),d},E=function(b,c,d){b.forEach(function(c){c.sections.forEach(function(d){c.displayAfterTile===b[b.length-1].displayAfterTile?a(v.SECTION_ID+d).detach().insertAfter(a("ul.tiles .tile").last()):a(v.SECTION_ID+d).detach().insertAfter(a("#tile-"+c.displayAfterTile))})}),"function"==typeof c&&c(),"function"==typeof d&&d()},F=function(b,c){if(c){if(b.html(c),a(v.TILE_LOADING_ICON).fadeOut(300,function(){a(v.TILE_LOADING_ICON).html("")}),b.attr("id")!==v.SECTION_ZERO){var e=b.find(v.ACTIVITY).not(v.SPACER);b.on(x.KEYDOWN,function(c){c.keyCode===z.ESCAPE&&(d.setLastVisitedSection(0),C(0),a(v.TILEID+b.attr("data-section")).focus())}),e.on(x.KEYDOWN,function(b){if(b.keyCode===z.RETURN){var c=a(b.currentTarget).find("a");c.hasClass(w.LAUNCH_CM_MODAL)?c.click():void 0!==c.attr("href")&&(window.location=c.attr("href"))}}),h||(e.last().on(x.KEYDOWN,function(c){c.keyCode!==z.TAB||c.shiftKey||a(c.relatedTarget).closest(v.SECTION_MAIN).attr("id")===b.attr("id")||setTimeout(function(){b.find(v.SECTION_TITLE).focus(),o.animate({scrollTop:b.offset().top-s},"slow"),b.find("#sectionbuttons").css("top","")},200)}),b.find(v.SECTION_TITLE).on(x.KEYDOWN,function(c){c.keyCode===z.TAB&&c.shiftKey&&a(c.relatedTarget).closest(v.SECTION_MAIN).attr("id")!==b.attr("id")&&setTimeout(function(){e.last().focus()},200)}))}return h||setTimeout(function(){b.find(".togglecompletion").tooltip(),b.find(".completioncheckbox").tooltip(),b.find(".tag-info").tooltip()},500),0!==b.find(v.MOODLE_VIDEO).length&&require(["media_videojs/loader"],function(a){a.setUp()}),!0}return!1},G=function(b,c){var d=function(){var d=a("#tileText-"+c).offset().top-s;d===a(window).scrollTop&&(d+=1),b.find(v.SECTION_TITLE).focus();var e="scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove";n.on(e,function(){n.stop()}),o.animate({scrollTop:d},"slow",function(){o.off(e,function(){o.stop()})}),r=!0,b.find("li.activity").first().focus()},e=function(){var c=b.find(v.SECTION_BUTTONS);a(window).on(x.SCROLL,function(){!q&&r&&(q=!0,c.fadeOut(300),setTimeout(function(){var d=a(window).scrollTop(),e=d-b.offset().top+50;e>0&&e<b.outerHeight()-100?(e=d-b.offset().top+50,c.css("top",e),"none"===l.css(y.DISPLAY)&&l.fadeIn(300)):e<0&&c.css("top",0),d>b.offset().top+b.outerHeight()-50?("block"===l.css(y.DISPLAY)&&(l.fadeOut(300),A(!1)),c.css("top",0)):b.offset().top>d+a(window).outerHeight()?("block"===l.css(y.DISPLAY)&&(l.fadeOut(300),A(!1)),c.css("top",0)):"none"===l.css(y.DISPLAY)&&l.fadeIn(300),c.fadeIn(300,function(){q=!1})},500))}),q||r||!l.is(":visible")||l.fadeOut(300)};b.addClass(w.STATE_VISIBLE),b.slideDown(350,function(){Math.abs(b.position().top-a(v.TILEID+c).position().top)>300?E(D(),d,e):(d(),e())})},H=function(a,b,c){throw b?(e.confirm(k.sectionerrortitle,k.sectionerrorstring,k.refresh,k.cancel,function(){window.location.reload()},null),c.html("")):(F(c,"<p>"+k.noconnectionerror+"</p>"),setTimeout(function(){G(c,a)},500)),require(["core/log"],function(a){a.debug(b)}),new Error("Not successful retrieving tile content by AJAX for section "+a)},I=function(a,b){return c.call([{methodname:"format_tiles_get_single_section_page_html",args:{courseid:a,sectionid:b,setjsusedsession:!0}}])[0]},J=function(a,b,c,d){var e=d<0?0:255,f=d<0?d*-1:d,g=Math.round((e-a)*f)+a,h=Math.round((e-b)*f)+b,i=Math.round((e-c)*f)+c;return"rgb("+g+","+h+","+i+")"},K=function(b){l.fadeIn(300),u=parseInt(l.css(y.Z_INDEX));var c=a(v.TILEID+b);if(c.css(y.Z_INDEX,u+1),A(!0),a(v.SECTION_ID+b).css(y.Z_INDEX,u+1),c.css(y.BG_COLOUR)&&"rgba"===c.css(y.BG_COLOUR).substr(0,4)){var d=c.css(y.BG_COLOUR).replace("rgba(","").replace(")","").replace(" ","").split(",");c.css(y.BG_COLOUR,J(parseInt(d[0]),parseInt(d[1]),parseInt(d[2]),.95))}},L=function(b){var c=a(b.currentTarget);if("window-overlay"===c.attr("id")||c.attr("id")===w.HEADER_OVERLAY){c.hide();var d=a(document.elementFromPoint(b.clientX,b.clientY));if(c.show(),"window-overlay"===c.attr("id"))if(d.hasClass("filterbutton")||d.hasClass("list-group-item"))d.click();else{var e=d.closest(v.TILE);e&&e.click()}else C(0),d.click()}},M=function(){var b=a(v.HIDE_SEC0_BTN),c=a(v.SECTION_ZERO);d.storageEnabledLocal()?d.getSecZeroCollapseStatus()===!0?(c.slideUp(0),b.addClass(w.CLOSED).removeClass(w.OPEN)):(c.slideDown(300),b.addClass(w.OPEN).removeClass(w.CLOSED)):(b.addClass(w.OPEN).removeClass(w.CLOSED),c.slideDown(300))},N=function(b,c,e){p!==!0&&(p=!0,C(0),setTimeout(function(){E(D(),function(){var b=null;h||("number"==typeof e&&0!==e?b=e:"1"===t&&d.storageEnabledLocal&&d.storageUserPreference&&(b=d.getLastVisitedSection()),null!==b?a(v.TILEID+b).click():a(v.TILEID+"1").focus()),p=!1},null)},c),a("body").removeClass("modal-open"))},O=function(b,f,g,h){K(g),a(v.TILE).removeClass(w.SELECTED),f.addClass(w.SELECTED),a(v.MOVEABLE_SECTION).each(function(b,c){c=a(c),c.is(":visible")&&(B(c.attr("data-section")),c.slideUp(200).removeClass(w.STATE_VISIBLE))}),c.call([{methodname:"format_tiles_log_tile_click",args:{courseid:b,sectionid:g}}])[0].fail(e.exception);var i=a(v.SECTION_ID+g);if(i.find(".content").length>0)G(i,g),I(b,g).done(function(c){d.storageEnabledSession()&&d.storeCourseContent(b,g,a(c.html).html())});else if(i.html(j),d.storageEnabledLocal()){var k=d.getStoredContentAge(b,g);if(k&&(F(i,d.getCourseContent(b,g)),G(i,g)),!k||k>h){var l=a(v.TILE_LOADING_ICON_ID+g);void 0!==l?l.html(j).fadeIn(200):(l=a("<div>").html(j),i.html(l)),I(b,g).done(function(c){var e=a(c.html).html();F(i,e),G(i,g),d.storageEnabledSession()&&d.storeCourseContent(b,g,e)}).fail(function(a){H(g,a,i),C(g)})}}else I(b,g).done(function(b){F(i,a(b.html).html()),G(i,g)}).fail(function(a){H(g,a,i),C(g)});d.setLastVisitedSection(g)};return{init:function(o,p,q,r,A,B,G,H,J,K,P,Q){t=P,h=A,i=p,d.init(o,r,i,B,H,K,Q),a(document).ready(function(){var p=a("#page-content");0===p.length&&(p=a("#region-main"));var r=a(window).outerWidth();if(q&&!i){l=a("<div></div>").addClass("modal-backdrop fade in").hide().attr("id","window-overlay").appendTo(n),l.click(function(a){C(0),L(a)}),p.on(x.CLICK,v.TILE_CLICKABLE,function(b){if(q){b.preventDefault(),a(window).off(x.SCROLL),a(v.TILE_LOADING_ICON).fadeOut(300,function(){a(v.TILE_LOADING_ICON).html()});var c=a(b.currentTarget).closest(v.TILE),e=parseInt(c.attr("data-section"));c.hasClass(w.SELECTED)?(C(e),d.setLastVisitedSection(0)):O(o,c,e,G);var f=a(v.SECTION_ID+(e+1));!h&&f.length&&e>0&&setTimeout(function(){var b=d.getStoredContentAge(o,e+1);b&&F(f,d.getCourseContent(o,e+1)),(!b||b>G)&&I(o,e+1).done(function(b){F(f,a(b.html).html())})},2e3)}}),a(window).on("resize",function(){i||r===a(window).outerWidth()||(r=a(window).outerWidth(),N(o,1e3,0))}),a(".block-hider-hide").click(function(){N(o,1e3,0)}),a(".block-hider-show").click(function(){N(o,1e3,0)}),a(".navbar-nav .btn").click(function(){N(o,1e3,0)});var t=parseInt(l.css(y.Z_INDEX)),A=a(v.HEADER_BAR.find(function(b){return a(b).length>0}));void 0!==A&&0!==A.length&&(A.css(y.Z_INDEX,t+2),"navwrap"!==A.attr("id")&&void 0!==A.height()&&(s=Math.max(A.height(),50),m=a("<div></div>").addClass(w.HEADER_OVERLAY).attr("id",w.HEADER_OVERLAY).css(y.DISPLAY,"none"),m.insertAfter(v.PAGE).css(y.Z_INDEX,t+3).css(y.HEIGHT,s).click(function(a){C(0),L(a)}))),p.on(x.CLICK,v.CLOSE_SEC_BTN,function(b){C(a(b.currentTarget).attr("data-section"))}),N(o,0,B),p.on(x.CLICK,v.LAUNCH_STANDARD,function(b){var c=a(b.currentTarget);void 0!==c.attr("href")?window.location=c.attr("href"):void 0!==c.find("a").attr("href")&&(window.location=c.find("a").attr("href"))}),p.on(x.CLICK,v.URLACTIVITYPOPUPLINK,function(b){var d=a(b.currentTarget).closest(v.ACTIVITY);void 0!==d.attr("data-url")&&(b.stopPropagation(),b.preventDefault(),c.call([{methodname:"format_tiles_log_mod_view",args:{courseid:o,cmid:d.attr("data-cmid")}}])[0].done(function(){require(["format_tiles/completion"],function(a){a.markAsAutoCompleteInUI(o,d)});var a=window.open(d.attr("data-url"));try{a.focus()}catch(b){var c='<div><a href="'+d.attr("data-url")+'">'+d.attr("data-url")+"</a></div>";e.alert(k.blockedpopuptitle,k.blockedpopup+c,k.cancel)}}).fail(e.exception))})}if(p.on(x.CLICK,v.HIDE_SEC0_BTN,function(b){var c=a(v.SECTION_ZERO);"none"===c.css(y.DISPLAY)?(c.slideDown(250),a(b.currentTarget).addClass(w.OPEN).removeClass(w.CLOSED),d.setSecZeroCollapseStatus("collapsed")):(c.slideUp(250),a(b.currentTarget).addClass(w.CLOSED).removeClass(w.OPEN),d.setSecZeroCollapseStatus("expanded"))}),M(),b.render("format_tiles/loading",{}).done(function(a){j=a}),!h){var H=a("[data-toggle=tooltip]");0!==H.length&&H.tooltip()}!i&&J&&(require(["format_tiles/filter_buttons"],function(a){a.init(o,d.storageEnabledLocal)}),q&&p.on(x.CLICK,v.FILTER_BUTTON,function(){C(0),setTimeout(function(){E(D(),null,null)},1500)})),a(".tiles_coursenav").removeClass("hidden"),f.get_strings([{key:"sectionerrortitle",component:"format_tiles"},{key:"sectionerrorstring",component:"format_tiles"},{key:"refresh"},{key:"cancel"},{key:"noconnectionerror",component:"format_tiles"},{key:"show"},{key:"hide"},{key:"other",component:"format_tiles"},{key:"blockedpopuptitle",component:"format_tiles"},{key:"blockedpopup",component:"format_tiles"}]).done(function(a){k={sectionerrortitle:a[0],sectionerrorstring:a[1],refresh:a[2],cancel:a[3],noconnectionerror:a[4],show:a[5],hide:a[6],other:a[7],blockedpopuptitle:a[8],blockedpopup:a[9]}}),h||(a(v.TILE).on(x.KEYDOWN,function(b){b.keyCode===z.RETURN&&a(b.currentTarget).click()}),i&&a(".tile_bar_text").on(x.KEYDOWN,function(b){b.keyCode!==z.RETURN||a(b.target).hasClass("form-control")||(window.location=g.wwwroot+"/course/view.php?id="+o+"&section="+a(b.currentTarget).parent().attr("data-section"))}),a("ul.tiles .tile").first().focus()),a(document).on("filter-content-updated",function(b,c){if(c.length>0){var d=a(c[0]);d.hasClass("moodle-dialogue")&&d.css("z-index")<u&&d.css("z-index",u+1)}})})}}});