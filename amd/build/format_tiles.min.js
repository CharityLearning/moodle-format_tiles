define(["jquery","core/templates","core/ajax","format_tiles/browser_storage","core/notification","core/str"],function(a,b,c,d,e,f){"use strict";var g,h,i,j,k,l,m=a("body"),n=a("#page"),o=!1,p=!1,q=!1,r={PAGE:"#page",TILE:".tile",MOVEABLE_SECTION:".moveablesection",FILTER_BUTTON:".filterbutton",TILE_LOADING_ICON:".tile-loading-icon",TILE_COLLAPSED:".tile-collapsed",ACTIVITY:".activity",SPACER:".spacer",SECTION_MOVEABLE:".moveablesection",SECTION_ID:"#section-",SECTION_TITLE:".sectiontitle",SECTION_MAIN:".section.main",SECTION_BUTTONS:"#sectionbuttons",CLOSE_SEC_BTN:".closesectionbtn",HIDE_SEC0_BTN:"#buttonhidesec0",SECTION_ZERO:"#section-0",LAUNCH_STANDARD:'[data-action="launch-tiles-standard"]',HEADER_BAR:["header.navbar","nav.fixed-top.navbar","#essentialnavbar.navbar"]},s={SELECTED:"selected",HEADER_OVERLAY:"header-overlay",OPEN:"open",CLOSED:"closed",LAUNCH_CM_MODAL:"launch-tiles-cm-modal"},t={CLICK:"click",KEYDOWN:"keydown",SCROLL:"scroll"},u={DISPLAY:"display",Z_INDEX:"z-index",HEIGHT:"height",BG_COLOUR:"background-color"},v={ESCAPE:27,TAB:9,RETURN:13},w=function(b){a(r.TILE).removeClass(s.SELECTED).css(u.Z_INDEX,"").css(u.BG_COLOUR,""),a(".section "+s.SELECTED).removeClass(s.SELECTED).css(u.Z_INDEX,""),k.fadeOut(300),l.fadeOut(0),a(r.MOVEABLE_SECTION).slideUp(),void 0!==b&&0!==b&&a("#tile-"+b).focus(),a(r.TILE_LOADING_ICON).fadeOut(300,function(){a(r.TILE_LOADING_ICON).html("")}),q=!1},x=function(){var b,c,d=[];return a("ul.tiles").children(r.TILE).not(a(r.TILE_COLLAPSED)).each(function(e,f){b=a(f).attr("data-section");var g=100;b&&(0===e?d[0]={displayAfterTile:"",sections:[b]}:Math.abs(a(f).position().top-a(c).position().top)<=g?d[d.length-1].sections.push(b):d.push({displayAfterTile:"",sections:[b]}),c=f,d[d.length-1].displayAfterTile=b)}),d},y=function(b,c,d){b.forEach(function(c){c.sections.forEach(function(d){c.displayAfterTile===b[b.length-1].displayAfterTile?a(r.SECTION_ID+d).detach().insertAfter(a("ul.tiles .tile").last()):a(r.SECTION_ID+d).detach().insertAfter(a("#tile-"+c.displayAfterTile))})}),"function"==typeof c&&c(),"function"==typeof d&&d()},z=function(b,c){if(c){if(b.html(c),a(r.TILE_LOADING_ICON).fadeOut(300,function(){a(r.TILE_LOADING_ICON).html("")}),b.attr("id")!==r.SECTION_ZERO){var e=b.find(r.ACTIVITY).not(r.SPACER);e.on(t.KEYDOWN,function(c){if(c.keyCode===v.ESCAPE)d.setLastVisitedSection(0),w(0),a("#tile-"+b.attr("data-section")).focus();else if(c.keyCode===v.RETURN){var e=a(c.currentTarget).find("a");e.hasClass(s.LAUNCH_CM_MODAL)?e.click():void 0!==e.attr("href")&&(window.location=e.attr("href"))}}),g||(e.last().on(t.KEYDOWN,function(c){c.keyCode!==v.TAB||c.shiftKey||a(c.relatedTarget).closest(r.SECTION_MAIN).attr("id")===b.attr("id")||setTimeout(function(){b.find(r.SECTION_TITLE).focus()},200)}),b.find(r.SECTION_TITLE).on(t.KEYDOWN,function(c){c.keyCode===v.TAB&&c.shiftKey&&a(c.relatedTarget).closest(r.SECTION_MAIN).attr("id")!==b.attr("id")&&setTimeout(function(){e.last().focus()},200)}))}return g||setTimeout(function(){b.find(".togglecompletion").tooltip(),b.find(".completioncheckbox").tooltip(),b.find(".tag-info").tooltip()},500),!0}return!1},A=function(b,c){var d=function(){var d=a("#tileText-"+c).offset().top-60;d===a(window).scrollTop&&(d+=1),b.find(r.SECTION_TITLE).focus();var e="scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove";m.on(e,function(){m.stop()});var f=a("body, html");f.animate({scrollTop:d},"slow",function(){f.off(e,function(){f.stop()})}),q=!0,b.find("li.activity").first().focus()},e=function(){var c=b.find(r.SECTION_BUTTONS);a(window).on(t.SCROLL,function(){!p&&q&&(p=!0,c.fadeOut(300),setTimeout(function(){var d=a(window).scrollTop(),e=d-b.offset().top+50;e>0&&e<b.outerHeight()-100?(e=d-b.offset().top+50,c.css("top",e),"none"===k.css(u.DISPLAY)&&k.fadeIn(300)):d>b.offset().top+b.outerHeight()-50?("block"===k.css(u.DISPLAY)&&(k.fadeOut(300),l.fadeOut(300)),c.css("top",0)):b.offset().top>d+a(window).outerHeight()?("block"===k.css(u.DISPLAY)&&(k.fadeOut(300),l.fadeOut(300)),c.css("top",0)):"none"===k.css(u.DISPLAY)&&k.fadeIn(300),c.fadeIn(300,function(){p=!1})},500))}),p||q||!k.is(":visible")||k.fadeOut(300)};b.slideDown(350,function(){Math.abs(b.position().top-a("#tile-"+c).position().top)>300?y(x(),d,e):(d(),e())})},B=function(a,b,c){throw b?(e.confirm(j.sectionerrortitle,j.sectionerrorstring,j.refresh,j.cancel,function(){window.location.reload()},null),c.html("")):(z(c,"<p>"+j.noconnectionerror+"</p>"),A(c,a)),new Error("Not successful retrieving tile content by AJAX for section "+a)},C=function(a,b){return c.call([{methodname:"format_tiles_get_single_section_page_html",args:{courseid:a,sectionid:b,setjsusedsession:!0}}])[0]},D=function(a,b,c,d){var e=d<0?0:255,f=d<0?d*-1:d,g=Math.round((e-a)*f)+a,h=Math.round((e-b)*f)+b,i=Math.round((e-c)*f)+c;return"rgb("+g+","+h+","+i+")"},E=function(b){k.fadeIn(300);var c=parseInt(k.css(u.Z_INDEX)),d=a("#tile-"+b);if(d.css(u.Z_INDEX,c+1),l.fadeIn(300),a(r.SECTION_ID+b).css(u.Z_INDEX,c+1),d.css(u.BG_COLOUR)&&"rgba"===d.css(u.BG_COLOUR).substr(0,4)){var e=d.css(u.BG_COLOUR).replace("rgba(","").replace(")","").replace(" ","").split(",");d.css(u.BG_COLOUR,D(parseInt(e[0]),parseInt(e[1]),parseInt(e[2]),.95))}},F=function(b){var c=a(b.currentTarget);if("window-overlay"===c.attr("id")||c.attr("id")===s.HEADER_OVERLAY){c.hide();var d=a(document.elementFromPoint(b.clientX,b.clientY));if(c.show(),"window-overlay"===c.attr("id"))if(d.hasClass("filterbutton")||d.hasClass("list-group-item"))d.click();else{var e=d.closest(r.TILE);e&&e.click()}else w(0),d.click()}},G=function(){var b=a(r.HIDE_SEC0_BTN),c=a(r.SECTION_ZERO);d.storageEnabledLocal()?d.getSecZeroCollapseStatus()===!0?(c.slideUp(0),b.addClass(s.CLOSED).removeClass(s.OPEN)):(c.slideDown(300),b.addClass(s.OPEN).removeClass(s.CLOSED)):(b.addClass(s.OPEN).removeClass(s.CLOSED),c.slideDown(300))},H=function(b,c,e){o!==!0&&(o=!0,w(0),setTimeout(function(){y(x(),function(){var b=null;g||("number"==typeof e&&0!==e?b=e:d.storageEnabledLocal&&d.storageUserPreference&&(b=d.getLastVisitedSection()),null!==b?a("#tile-"+b).click():a("#tile-1").focus()),o=!1},null)},c),a("body").removeClass("modal-open"))};return{init:function(m,o,p,q,D,I,J,K,L,M){g=D,h=o,d.init(m,q,h,I,K,M),a(document).ready(function(){var o=a("#page-content"),q=a(window).outerWidth();if(p&&!h){k=a("<div></div>").addClass("modal-backdrop fade in").hide().attr("id","window-overlay").appendTo(n),k.click(function(a){w(0),F(a)}),o.on(t.CLICK,r.TILE,function(b){if(p){b.preventDefault(),a(window).off(t.SCROLL),a(r.TILE_LOADING_ICON).fadeOut(300,function(){a(r.TILE_LOADING_ICON).html()});var f=a(b.currentTarget).closest(r.TILE),h=parseInt(f.attr("data-section")),j=a(r.SECTION_ID+h);if(f.hasClass(s.SELECTED))w(h),d.setLastVisitedSection(0);else{if(E(h),a(r.TILE).removeClass(s.SELECTED),f.addClass(s.SELECTED),a(r.MOVEABLE_SECTION).slideUp(200),c.call([{methodname:"format_tiles_log_tile_click",args:{courseid:m,sectionid:h}}])[0].fail(e.exception),j.find(".content").length>0)A(j,h),C(m,h).done(function(b){d.storageEnabledSession()&&d.storeCourseContent(m,h,a(b.html).html())});else if(j.html(i),d.storageEnabledLocal()){var k=d.getStoredContentAge(m,h);if(k&&(z(j,d.getCourseContent(m,h)),A(j,h)),!k||k>J){var l=a("#loading-icon-"+I);void 0!==l?l.html(i).fadeIn(200):(l=a("<div>").html(i),j.html(l)),C(m,h).done(function(b){var c=a(b.html).html();z(j,c),A(j,h),d.storageEnabledSession()&&d.storeCourseContent(m,h,c)}).fail(function(a){B(h,a,j),w(h)})}}else C(m,h).done(function(b){z(j,a(b.html).html()),A(j,h)}).fail(function(a){B(h,a,j),w(h)});d.setLastVisitedSection(h)}var n=a(r.SECTION_ID+(h+1));!g&&n.length&&h>0&&setTimeout(function(){var b=d.getStoredContentAge(m,h+1);b&&z(n,d.getCourseContent(m,h+1)),(!b||b>J)&&C(m,h+1).done(function(b){z(n,a(b.html).html())})},2e3)}}),a(window).on("resize",function(){q!==a(window).outerWidth()&&(q=a(window).outerWidth(),H(m,1e3,0))}),a(".block-hider-hide").click(function(){H(m,1e3,0)}),a(".block-hider-show").click(function(){H(m,1e3,0)}),a(".navbar-nav .btn").click(function(){H(m,1e3,0)});var D=parseInt(k.css(u.Z_INDEX)),K=a(r.HEADER_BAR.find(function(b){return a(b).length>0}));void 0!==K&&K.css(u.Z_INDEX,D+2),void 0!==K.outerHeight()?(l=a("<div></div>").addClass(s.HEADER_OVERLAY).attr("id",s.HEADER_OVERLAY).css(u.DISPLAY,"none"),l.insertAfter(r.PAGE).css(u.Z_INDEX,D+3).css(u.HEIGHT,K.outerHeight()).click(function(a){w(0),F(a)})):l=a("<div></div>").insertAfter(r.PAGE).fadeOut(),o.on(t.CLICK,r.CLOSE_SEC_BTN,function(b){w(a(b.currentTarget).attr("data-section"))}),H(m,0,I),o.on(t.CLICK,r.LAUNCH_STANDARD,function(b){window.location=a(b.currentTarget).find("a").attr("href")})}o.on(t.CLICK,r.HIDE_SEC0_BTN,function(b){var c=a(r.SECTION_ZERO);"none"===c.css(u.DISPLAY)?(c.slideDown(250),a(b.currentTarget).addClass(s.OPEN).removeClass(s.CLOSED),d.setSecZeroCollapseStatus("collapsed")):(c.slideUp(250),a(b.currentTarget).addClass(s.CLOSED).removeClass(s.OPEN),d.setSecZeroCollapseStatus("expanded"))}),G(),b.render("format_tiles/loading",{}).done(function(a){i=a}),g||a("[data-toggle=tooltip]").tooltip(),!h&&L&&(require(["format_tiles/filter_buttons"],function(a){a.init(m,d.storageEnabledLocal)}),p&&o.on(t.CLICK,r.FILTER_BUTTON,function(){w(0),setTimeout(function(){y(x(),null,null)},1500)})),a(".tiles_coursenav").removeClass("hidden"),f.get_strings([{key:"sectionerrortitle",component:"format_tiles"},{key:"sectionerrorstring",component:"format_tiles"},{key:"refresh"},{key:"cancel"},{key:"noconnectionerror",component:"format_tiles"},{key:"show"},{key:"hide"},{key:"other",component:"format_tiles"}]).done(function(a){j={sectionerrortitle:a[0],sectionerrorstring:a[1],refresh:a[2],cancel:a[3],noconnectionerror:a[4],show:a[5],hide:a[6],other:a[7]}}),g||(a(r.TILE).on(t.KEYDOWN,function(b){b.keyCode===v.RETURN&&a(b.currentTarget).click()}),a("ul.tiles .tile").first().focus())})}}});