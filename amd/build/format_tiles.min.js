define(["jquery","core/templates","core/ajax","format_tiles/browser_storage","core/notification","core/str","core/config","media_videojs/loader"],function(a,b,c,d,e,f,g,h){"use strict";var i,j,k,l,m,n,o=a("body"),p=a("#page"),q=a("body, html"),r=!1,s=!1,t=!1,u=60,v="0",w={PAGE:"#page",TILE:".tile",MOVEABLE_SECTION:".moveablesection",FILTER_BUTTON:".filterbutton",TILE_LOADING_ICON:".tile-loading-icon",TILE_COLLAPSED:".tile-collapsed",ACTIVITY:".activity",SPACER:".spacer",SECTION_MOVEABLE:".moveablesection",SECTION_ID:"#section-",SECTION_TITLE:".sectiontitle",SECTION_MAIN:".section.main",SECTION_BUTTONS:"#sectionbuttons",CLOSE_SEC_BTN:".closesectionbtn",HIDE_SEC0_BTN:"#buttonhidesec0",SECTION_ZERO:"#section-0",LAUNCH_STANDARD:'[data-action="launch-tiles-standard"]',HEADER_BAR:["header.navbar","nav.fixed-top.navbar","#essentialnavbar.navbar"]},x={SELECTED:"selected",HEADER_OVERLAY:"header-overlay",OPEN:"open",CLOSED:"closed",LAUNCH_CM_MODAL:"launch-tiles-cm-modal",STATE_VISIBLE:"state-visible"},y={CLICK:"click",KEYDOWN:"keydown",SCROLL:"scroll"},z={DISPLAY:"display",Z_INDEX:"z-index",HEIGHT:"height",BG_COLOUR:"background-color"},A={ESCAPE:27,TAB:9,RETURN:13},B=function(b){a(w.TILE).removeClass(x.SELECTED).css(z.Z_INDEX,"").css(z.BG_COLOUR,""),a(".section "+x.SELECTED).removeClass(x.SELECTED).css(z.Z_INDEX,""),m.fadeOut(300),n.fadeOut(0),a(w.MOVEABLE_SECTION).slideUp().removeClass(x.STATE_VISIBLE),void 0!==b&&0!==b&&a("#tile-"+b).focus(),a(w.TILE_LOADING_ICON).fadeOut(300,function(){a(w.TILE_LOADING_ICON).html("")}),t=!1},C=function(){var b,c,d=[];return a("ul.tiles").children(w.TILE).not(a(w.TILE_COLLAPSED)).each(function(e,f){b=a(f).attr("data-section");var g=100;b&&(0===e?d[0]={displayAfterTile:"",sections:[b]}:Math.abs(a(f).position().top-a(c).position().top)<=g?d[d.length-1].sections.push(b):d.push({displayAfterTile:"",sections:[b]}),c=f,d[d.length-1].displayAfterTile=b)}),d},D=function(b,c,d){b.forEach(function(c){c.sections.forEach(function(d){c.displayAfterTile===b[b.length-1].displayAfterTile?a(w.SECTION_ID+d).detach().insertAfter(a("ul.tiles .tile").last()):a(w.SECTION_ID+d).detach().insertAfter(a("#tile-"+c.displayAfterTile))})}),"function"==typeof c&&c(),"function"==typeof d&&d()},E=function(b,c){if(c){if(b.html(c),a(w.TILE_LOADING_ICON).fadeOut(300,function(){a(w.TILE_LOADING_ICON).html("")}),b.attr("id")!==w.SECTION_ZERO){var e=b.find(w.ACTIVITY).not(w.SPACER);b.on(y.KEYDOWN,function(c){c.keyCode===A.ESCAPE&&(d.setLastVisitedSection(0),B(0),a("#tile-"+b.attr("data-section")).focus())}),e.on(y.KEYDOWN,function(b){if(b.keyCode===A.RETURN){var c=a(b.currentTarget).find("a");c.hasClass(x.LAUNCH_CM_MODAL)?c.click():void 0!==c.attr("href")&&(window.location=c.attr("href"))}}),i||(e.last().on(y.KEYDOWN,function(c){c.keyCode!==A.TAB||c.shiftKey||a(c.relatedTarget).closest(w.SECTION_MAIN).attr("id")===b.attr("id")||setTimeout(function(){b.find(w.SECTION_TITLE).focus(),q.animate({scrollTop:b.offset().top-u},"slow"),b.find("#sectionbuttons").css("top","")},200)}),b.find(w.SECTION_TITLE).on(y.KEYDOWN,function(c){c.keyCode===A.TAB&&c.shiftKey&&a(c.relatedTarget).closest(w.SECTION_MAIN).attr("id")!==b.attr("id")&&setTimeout(function(){e.last().focus()},200)}))}return i||setTimeout(function(){b.find(".togglecompletion").tooltip(),b.find(".completioncheckbox").tooltip(),b.find(".tag-info").tooltip()},500),0!==b.find(".mediaplugin").length&&h.setUp(),!0}return!1},F=function(b,c){var d=function(){var d=a("#tileText-"+c).offset().top-u;d===a(window).scrollTop&&(d+=1),b.find(w.SECTION_TITLE).focus();var e="scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove";o.on(e,function(){o.stop()}),q.animate({scrollTop:d},"slow",function(){q.off(e,function(){q.stop()})}),t=!0,b.find("li.activity").first().focus()},e=function(){var c=b.find(w.SECTION_BUTTONS);a(window).on(y.SCROLL,function(){!s&&t&&(s=!0,c.fadeOut(300),setTimeout(function(){var d=a(window).scrollTop(),e=d-b.offset().top+50;e>0&&e<b.outerHeight()-100?(e=d-b.offset().top+50,c.css("top",e),"none"===m.css(z.DISPLAY)&&m.fadeIn(300)):d>b.offset().top+b.outerHeight()-50?("block"===m.css(z.DISPLAY)&&(m.fadeOut(300),n.fadeOut(300)),c.css("top",0)):b.offset().top>d+a(window).outerHeight()?("block"===m.css(z.DISPLAY)&&(m.fadeOut(300),n.fadeOut(300)),c.css("top",0)):"none"===m.css(z.DISPLAY)&&m.fadeIn(300),c.fadeIn(300,function(){s=!1})},500))}),s||t||!m.is(":visible")||m.fadeOut(300)};b.addClass(x.STATE_VISIBLE),b.slideDown(350,function(){Math.abs(b.position().top-a("#tile-"+c).position().top)>300?D(C(),d,e):(d(),e())})},G=function(a,b,c){throw b?(e.confirm(l.sectionerrortitle,l.sectionerrorstring,l.refresh,l.cancel,function(){window.location.reload()},null),c.html("")):(E(c,"<p>"+l.noconnectionerror+"</p>"),F(c,a)),new Error("Not successful retrieving tile content by AJAX for section "+a)},H=function(a,b){return c.call([{methodname:"format_tiles_get_single_section_page_html",args:{courseid:a,sectionid:b,setjsusedsession:!0}}])[0]},I=function(a,b,c,d){var e=d<0?0:255,f=d<0?d*-1:d,g=Math.round((e-a)*f)+a,h=Math.round((e-b)*f)+b,i=Math.round((e-c)*f)+c;return"rgb("+g+","+h+","+i+")"},J=function(b){m.fadeIn(300);var c=parseInt(m.css(z.Z_INDEX)),d=a("#tile-"+b);if(d.css(z.Z_INDEX,c+1),n.fadeIn(300),a(w.SECTION_ID+b).css(z.Z_INDEX,c+1),d.css(z.BG_COLOUR)&&"rgba"===d.css(z.BG_COLOUR).substr(0,4)){var e=d.css(z.BG_COLOUR).replace("rgba(","").replace(")","").replace(" ","").split(",");d.css(z.BG_COLOUR,I(parseInt(e[0]),parseInt(e[1]),parseInt(e[2]),.95))}},K=function(b){var c=a(b.currentTarget);if("window-overlay"===c.attr("id")||c.attr("id")===x.HEADER_OVERLAY){c.hide();var d=a(document.elementFromPoint(b.clientX,b.clientY));if(c.show(),"window-overlay"===c.attr("id"))if(d.hasClass("filterbutton")||d.hasClass("list-group-item"))d.click();else{var e=d.closest(w.TILE);e&&e.click()}else B(0),d.click()}},L=function(){var b=a(w.HIDE_SEC0_BTN),c=a(w.SECTION_ZERO);d.storageEnabledLocal()?d.getSecZeroCollapseStatus()===!0?(c.slideUp(0),b.addClass(x.CLOSED).removeClass(x.OPEN)):(c.slideDown(300),b.addClass(x.OPEN).removeClass(x.CLOSED)):(b.addClass(x.OPEN).removeClass(x.CLOSED),c.slideDown(300))},M=function(b,c,e){r!==!0&&(r=!0,B(0),setTimeout(function(){D(C(),function(){var b=null;i||("number"==typeof e&&0!==e?b=e:"1"===v&&d.storageEnabledLocal&&d.storageUserPreference&&(b=d.getLastVisitedSection()),null!==b?a("#tile-"+b).click():a("#tile-1").focus()),r=!1},null)},c),a("body").removeClass("modal-open"))};return{init:function(h,o,q,r,s,t,u,I,N,O,P,Q){v=P,i=s,j=o,d.init(h,r,j,t,I,O,Q),a(document).ready(function(){var o=a("#page-content"),r=a(window).outerWidth();if(q&&!j){m=a("<div></div>").addClass("modal-backdrop fade in").hide().attr("id","window-overlay").appendTo(p),m.click(function(a){B(0),K(a)}),o.on(y.CLICK,w.TILE,function(b){if(q){b.preventDefault(),a(window).off(y.SCROLL),a(w.TILE_LOADING_ICON).fadeOut(300,function(){a(w.TILE_LOADING_ICON).html()});var f=a(b.currentTarget).closest(w.TILE),g=parseInt(f.attr("data-section")),j=a(w.SECTION_ID+g);if(f.hasClass(x.SELECTED))B(g),d.setLastVisitedSection(0);else{if(J(g),a(w.TILE).removeClass(x.SELECTED),f.addClass(x.SELECTED),a(w.MOVEABLE_SECTION).slideUp(200),c.call([{methodname:"format_tiles_log_tile_click",args:{courseid:h,sectionid:g}}])[0].fail(e.exception),j.find(".content").length>0)F(j,g),H(h,g).done(function(b){d.storageEnabledSession()&&d.storeCourseContent(h,g,a(b.html).html())});else if(j.html(k),d.storageEnabledLocal()){var l=d.getStoredContentAge(h,g);if(l&&(E(j,d.getCourseContent(h,g)),F(j,g)),!l||l>u){var m=a("#loading-icon-"+t);void 0!==m?m.html(k).fadeIn(200):(m=a("<div>").html(k),j.html(m)),H(h,g).done(function(b){var c=a(b.html).html();E(j,c),F(j,g),d.storageEnabledSession()&&d.storeCourseContent(h,g,c)}).fail(function(a){G(g,a,j),B(g)})}}else H(h,g).done(function(b){E(j,a(b.html).html()),F(j,g)}).fail(function(a){G(g,a,j),B(g)});d.setLastVisitedSection(g)}var n=a(w.SECTION_ID+(g+1));!i&&n.length&&g>0&&setTimeout(function(){var b=d.getStoredContentAge(h,g+1);b&&E(n,d.getCourseContent(h,g+1)),(!b||b>u)&&H(h,g+1).done(function(b){E(n,a(b.html).html())})},2e3)}}),a(window).on("resize",function(){r!==a(window).outerWidth()&&(r=a(window).outerWidth(),M(h,1e3,0))}),a(".block-hider-hide").click(function(){M(h,1e3,0)}),a(".block-hider-show").click(function(){M(h,1e3,0)}),a(".navbar-nav .btn").click(function(){M(h,1e3,0)});var s=parseInt(m.css(z.Z_INDEX)),v=a(w.HEADER_BAR.find(function(b){return a(b).length>0}));void 0!==v&&v.css(z.Z_INDEX,s+2),void 0!==v.outerHeight()?(n=a("<div></div>").addClass(x.HEADER_OVERLAY).attr("id",x.HEADER_OVERLAY).css(z.DISPLAY,"none"),n.insertAfter(w.PAGE).css(z.Z_INDEX,s+3).css(z.HEIGHT,v.outerHeight()).click(function(a){B(0),K(a)})):n=a("<div></div>").insertAfter(w.PAGE).fadeOut(),o.on(y.CLICK,w.CLOSE_SEC_BTN,function(b){B(a(b.currentTarget).attr("data-section"))}),M(h,0,t),o.on(y.CLICK,w.LAUNCH_STANDARD,function(b){var c=a(b.currentTarget);void 0!==c.attr("href")?window.location=c.attr("href"):void 0!==c.find("a").attr("href")&&(window.location=c.find("a").attr("href"))})}o.on(y.CLICK,w.HIDE_SEC0_BTN,function(b){var c=a(w.SECTION_ZERO);"none"===c.css(z.DISPLAY)?(c.slideDown(250),a(b.currentTarget).addClass(x.OPEN).removeClass(x.CLOSED),d.setSecZeroCollapseStatus("collapsed")):(c.slideUp(250),a(b.currentTarget).addClass(x.CLOSED).removeClass(x.OPEN),d.setSecZeroCollapseStatus("expanded"))}),L(),b.render("format_tiles/loading",{}).done(function(a){k=a}),i||a("[data-toggle=tooltip]").tooltip(),!j&&N&&(require(["format_tiles/filter_buttons"],function(a){a.init(h,d.storageEnabledLocal)}),q&&o.on(y.CLICK,w.FILTER_BUTTON,function(){B(0),setTimeout(function(){D(C(),null,null)},1500)})),a(".tiles_coursenav").removeClass("hidden"),f.get_strings([{key:"sectionerrortitle",component:"format_tiles"},{key:"sectionerrorstring",component:"format_tiles"},{key:"refresh"},{key:"cancel"},{key:"noconnectionerror",component:"format_tiles"},{key:"show"},{key:"hide"},{key:"other",component:"format_tiles"}]).done(function(a){l={sectionerrortitle:a[0],sectionerrorstring:a[1],refresh:a[2],cancel:a[3],noconnectionerror:a[4],show:a[5],hide:a[6],other:a[7]}}),i||(a(w.TILE).on(y.KEYDOWN,function(b){b.keyCode===A.RETURN&&a(b.currentTarget).click()}),j&&a(".tile_bar_text").on(y.KEYDOWN,function(b){b.keyCode!==A.RETURN||a(b.target).hasClass("form-control")||(window.location=g.wwwroot+"/course/view.php?id="+h+"&section="+a(b.currentTarget).parent().attr("data-section"))}),a("ul.tiles .tile").first().focus())})}}});