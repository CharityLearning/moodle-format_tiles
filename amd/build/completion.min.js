define(["jquery","core/templates","core/config","format_tiles/completion"],function(a,b,c){"use strict";var d={cmid:"data-cmid",numberComplete:"data-numcomplete",numberOutOf:"data-numoutof",section:"data-section"},e=function(a,b,c,d){var e={tileid:a,numComplete:b,numOutOf:c,showAsPercent:d,percent:Math.round(b/c*100),percentCircumf:106.8,percentOffset:Math.round((c-b)/c*106.8),isComplete:!1,isSingleDigit:!1};return 0===a?e.isOverall=1:e.isOverall=0,b>=c&&(e.isComplete=!0),e.percent<10&&(e.isSingleDigit=!0),e},f=function(f){var g=a("#completionstate_"+f.attr(d.cmid)),h={id:f.attr(d.cmid),completionstate:parseInt(g.attr("value")),fromajax:1,sesskey:c.sesskey},i=c.wwwroot+"/course/togglecompletion.php";a.post(i,h,function(c,h){if("success"===h&&"OK"===c){var i,j=f.find("img").attr("src"),k=a(".completion_img_"+f.attr(d.cmid)).find(".icon");"1"===g.attr("value")?(a("#completion_dynamic_change").attr("value",1),g.attr("value",0),i=1,k.attr("src",j.replace("completion-n","completion-y"))):(a("#completion_dynamic_change").attr("value",1),g.attr("value",1),i=-1,k.attr("src",j.replace("completion-y","completion-n")));var l=a("#tileprogress-"+f.attr(d.section)),m=parseInt(l.attr(d.numberComplete))+i;m>l.attr(d.numberOutOf)&&(m=l.attr(d.numberOutOf));var n=a("#tileprogress-0"),o=parseInt(n.attr(d.numberComplete))+i;o>n.attr(d.numberOutOf)&&(o=n.attr(d.numberOutOf)),b.render("format_tiles/progress",e(f.attr(d.section),m,l.attr(d.numberOutOf),l.hasClass("percent"))).done(function(b){l.replaceWith(b),a("#tileprogress-"+f.attr(d.section)).tooltip()}),b.render("format_tiles/progress",e(0,o,n.attr(d.numberOutOf),!0)).done(function(b){a("#tileprogress-0").replaceWith(b).fadeOut(0).animate({opacity:1},500)})}}).fail(function(){throw new Error("Failed to register completion change with server")})};return{init:function(){a(document).ready(function(){a("body").on("click",".togglecompletion",function(b){b.preventDefault(),f(a(b.currentTarget))})})}}});