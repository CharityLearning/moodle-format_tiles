define(["jquery","core/templates","core/config","format_tiles/completion"],function(a,b,c){"use strict";var d={},e={cmid:"data-cmid",numberComplete:"data-numcomplete",numberOutOf:"data-numoutof",section:"data-section"},f={launchModuleModal:'[data-action="launch-tiles-module-modal"]',pageContent:"#page-content",resourceModule:".activity.resource"},g={completionYes:"completion-icon-y",completionNo:"completion-icon-n"},h=[],i=function(a,b,c,d){var e={tileid:a,numComplete:b,numOutOf:c,showAsPercent:d,percent:Math.round(b/c*100),percentCircumf:106.8,percentOffset:Math.round((c-b)/c*106.8),isComplete:!1,isSingleDigit:!1};return 0===a?e.isOverall=1:e.isOverall=0,b>=c&&(e.isComplete=!0),e.percent<10&&(e.isSingleDigit=!0),e},j=function(c,d,f){if(!(0==d.attr(e.numberComplete)&&f<0)){var g=Math.min(parseInt(d.attr(e.numberComplete))+f,d.attr(e.numberOutOf)),h=a("#tileprogress-0"),j=Math.min(parseInt(h.attr(e.numberComplete))+f,h.attr(e.numberOutOf));b.render("format_tiles/progress",i(c,g,d.attr(e.numberOutOf),d.hasClass("percent"))).done(function(b){d.replaceWith(b),a("#tileprogress-"+c).tooltip()}),b.render("format_tiles/progress",i(0,j,h.attr(e.numberOutOf),!0)).done(function(b){a("#tileprogress-0").replaceWith(b).fadeOut(0).animate({opacity:1},500)})}},k=function(b){var d=b.attr(e.cmid),f=a("#completionstate_"+d),i={id:d,completionstate:parseInt(f.attr("value")),fromajax:1,sesskey:c.sesskey};b.tooltip("hide");var k=c.wwwroot+"/course/togglecompletion.php";a.post(k,i,function(c,i){if("success"===i&&"OK"===c){var k,l=a(".completion_img_"+d);"1"===f.attr("value")?(a("#completion_dynamic_change").attr("value",0),f.attr("value",0),k=1,l.addClass(g.completionYes).removeClass(g.completionNo),a(".complete-y-"+d).fadeIn(200).fadeOut(1e3)):(a("#completion_dynamic_change").attr("value",1),f.attr("value",1),k=-1,a(".complete-n-"+d).fadeIn(200).fadeOut(1e3),l.addClass(g.completionNo).removeClass(g.completionYes)),f.closest("li.activity").is(h.map(function(a){return"."+a}).join(","))||j(b.attr(e.section),a("#tileprogress-"+b.attr(e.section)),k)}}).fail(function(){throw new Error("Failed to register completion change with server")})},l=function(b){var c=a(b.currentTarget).closest("li.activity").find(".completion-icon");if("0"===c.attr("data-ismanual")&&"0"===c.attr("data-completionstate")){c.addClass(g.completionYes).removeClass(g.completionNo),c.attr("data-completionstate",1),c.attr("data-original-title",d.completeauto),c.tooltip();var e=c.closest("li.section.main").attr("data-section");j(e,a("#tileprogress-"+e),1)}};return{init:function(b,c){a(document).ready(function(){h=JSON.parse(c),d.completeauto=b,a("body").on("click",".togglecompletion",function(b){b.preventDefault(),k(a(b.currentTarget))}),a(f.pageContent).on("click",f.resourceModule,function(a){l(a)}),a(f.pageContent).on("click",f.launchModuleModal,function(a){l(a)})})}}});