define(["jquery","core/templates","core/config","format_tiles/completion"],function(a,b,c){"use strict";var d={},e={cmid:"data-cmid",numberComplete:"data-numcomplete",numberOutOf:"data-numoutof",section:"data-section"},f=function(a,b,c,d){var e={tileid:a,numComplete:b,numOutOf:c,showAsPercent:d,percent:Math.round(b/c*100),percentCircumf:106.8,percentOffset:Math.round((c-b)/c*106.8),isComplete:!1,isSingleDigit:!1};return 0===a?e.isOverall=1:e.isOverall=0,b>=c&&(e.isComplete=!0),e.percent<10&&(e.isSingleDigit=!0),e},g=function(d){var g=d.attr(e.cmid),h=a("#completionstate_"+g),i={id:g,completionstate:parseInt(h.attr("value")),fromajax:1,sesskey:c.sesskey};d.tooltip("hide");var j=c.wwwroot+"/course/togglecompletion.php";a.post(j,i,function(c,i){if("success"===i&&"OK"===c){var j,k=d.find("img").attr("src"),l=a(".completion_img_"+g).find(".icon");"1"===h.attr("value")?(a("#completion_dynamic_change").attr("value",1),h.attr("value",0),j=1,l.attr("src",k.replace("completion-n","completion-y")),a(".complete-y-"+g).fadeIn(200).fadeOut(1e3)):(a("#completion_dynamic_change").attr("value",1),h.attr("value",1),j=-1,a(".complete-n-"+g).fadeIn(200).fadeOut(1e3),l.attr("src",k.replace("completion-y","completion-n")));var m=a("#tileprogress-"+d.attr(e.section)),n=parseInt(m.attr(e.numberComplete))+j;n>m.attr(e.numberOutOf)&&(n=m.attr(e.numberOutOf));var o=a("#tileprogress-0"),p=parseInt(o.attr(e.numberComplete))+j;p>o.attr(e.numberOutOf)&&(p=o.attr(e.numberOutOf)),b.render("format_tiles/progress",f(d.attr(e.section),n,m.attr(e.numberOutOf),m.hasClass("percent"))).done(function(b){m.replaceWith(b),a("#tileprogress-"+d.attr(e.section)).tooltip()}),b.render("format_tiles/progress",f(0,p,o.attr(e.numberOutOf),!0)).done(function(b){a("#tileprogress-0").replaceWith(b).fadeOut(0).animate({opacity:1},500)})}}).fail(function(){throw new Error("Failed to register completion change with server")})};return{init:function(b,c){a(document).ready(function(){d.complete=b,d.notComplete=c,a("body").on("click",".togglecompletion",function(b){b.preventDefault(),g(a(b.currentTarget))})})}}});