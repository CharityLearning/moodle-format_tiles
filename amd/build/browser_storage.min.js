define(["jquery","core/str","core/notification"],function(a,b,c){"use strict";var d,e,f={local:!1,session:!1},g={GIVEN:"yes",DENIED:"no",userChoice:null},h={prefix:"mdl-",course:"mdl-course-",lastSection:"-lastSecId",content:"-content",lastUpdated:"-lastUpdated",userPrefStorage:"mdl-tiles-userPrefStorage",collapseSecZero:"-collapsesec0"},i=function(){return h.course+d+h.lastSection},j=function(a){return h.course+d+"-sec-"+a.toString()+h.content},k=function(a){return h.course+d.toString()+"-sec-"+a.toString()+h.lastUpdated},l=function(a){return a.substring(0,4)===h.prefix&&a.substr(-12)===h.lastUpdated},m=function(a,b){var c;if(!b)return!1;try{return"local"===a?c=localStorage:"session"===a&&(c=sessionStorage),"undefined"!=typeof c&&(c.setItem("testItem","testValue"),"testValue"===c.getItem("testItem")&&(c.removeItem("testItem"),!0))}catch(d){return!1}},n=function(){return Object.keys(sessionStorage).filter(function(a){return l(a)}).length},o=function(a,b,c){c&&""!==c&&f.session?(sessionStorage.setItem(j(b),c),sessionStorage.setItem(k(b),Math.round(Date.now()/1e3).toString())):(sessionStorage.removeItem(j(b)),sessionStorage.removeItem(k(b)))},p=function(a){var b=a.split("-");if(l(a))return{courseId:parseInt(b[2]),sectionId:parseInt(b[4]),title:b[5]};throw new Error("Invalid lastUpdated key")},q=function(a,b,c){if(b&&(Object.keys(localStorage).filter(function(a){return a.substring(0,4)===h.prefix&&a!==h.userPrefStorage}).forEach(function(a){localStorage.removeItem(a)}),Object.keys(sessionStorage).filter(function(a){return"mdl"===a.split("-")[0]}).forEach(function(c){if(l(c)){var d=p(c);b?o(d.courseId,d.sectionId,null):(sessionStorage.getItem(c)<Math.round(Date.now()/1e3)-60*a||0===a)&&o(d.courseId,d.sectionId,null)}})),!b){var d=Object.keys(sessionStorage).filter(function(a){return l(a)});if(d.length>c){var e,f=d.map(function(a){return parseInt(sessionStorage[a])}).sort(),g=f[f.length-c];d.filter(function(a){return sessionStorage[a]<g}).forEach(function(a){e=p(a),o(e.courseId,e.sectionId,null)})}}},r=function(){b.get_strings([{key:"datapref",component:"format_tiles"},{key:"dataprefquestion",component:"format_tiles"},{key:"yes"},{key:"no"}]).done(function(a){c.confirm(a[0],a[1],a[2],a[3],function(){g.userChoice=g.GIVEN,localStorage.setItem(h.userPrefStorage,g.GIVEN),f.local=m("local",e),f.session=m("session",e)},function(){g.userChoice=g.DENIED,localStorage.setItem(h.userPrefStorage,g.DENIED),q(0,1,0),f.local=0})})},s=function(a){a&&f.local?localStorage.setItem(i(),a.toString()):localStorage.removeItem(i())},t={init:function(b,c,i,j,k,l){d=b.toString(),e=c,g.userChoice=1===l?g.GIVEN:localStorage.getItem(h.userPrefStorage),g.userChoice===g.DENIED?(f.local=!1,f.session=0,q(0,1,0)):(f.local=m("local",e),f.session=m("session",e)),a(document).ready(function(){(f.local||f.session)&&null===g.userChoice&&setTimeout(function(){r(c)},500),a('a[href*="datapref"]').click(function(a){a.preventDefault(),r(c)}),a("#page").on("click",".togglecompletion",function(b){if(f.local){o(d,0,null);var c=a(b.currentTarget).attr("data-section");setTimeout(function(){o(d,c,a("#section-"+c).html())},1e3)}}),i&&(s(j),q(0,1,0),f.session&&o(d,j,null)),a("#page-content").on("click",".tile",function(){f.session&&n()>c&&setTimeout(function(){q(k,0,c)},2e3)})})},storageEnabledSession:function(){return f.session},storageEnabledLocal:function(){return f.local},storageUserPreference:function(){return g.userChoice===g.GIVEN},getLastVisitedSection:function(){return localStorage.getItem(i())},getCourseContent:function(a,b){return sessionStorage.getItem(j(b))},getStoredContentAge:function(a,b){var c=parseInt(sessionStorage.getItem(k(b)));return!!c&&Math.round(Date.now()/1e3-c)},setSecZeroCollapseStatus:function(a){f.local&&g.userChoice===g.GIVEN&&("collapsed"===a?localStorage.removeItem(h.course+d+h.collapseSecZero):localStorage.setItem(h.course+d+h.collapseSecZero,"1"))},getSecZeroCollapseStatus:function(){return!!localStorage.getItem(h.course+d+h.collapseSecZero)},storeCourseContent:function(a,b,c){g.userChoice===g.GIVEN&&o(a,b,c)},cleanUp:function(a,b,c){q(a,b,c)},launchUserPreferenceWindow:function(){r()},setLastVisitedSection:function(a){g.userChoice===g.GIVEN&&s(a)}};return t});