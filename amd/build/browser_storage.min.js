define(["jquery","core/str","core/notification"],function(a,b,c){"use strict";var d,e,f,g={local:!1,session:!1},h={local:"local",session:"session"},i={GIVEN:"yes",DENIED:"no",userChoice:null},j={prefix:"mdl-",course:"mdl-course-",lastSection:"-lastSecId",content:"-content",lastUpdated:"-lastUpdated",userPrefStorage:"mdl-tiles-userPrefStorage",collapseSecZero:"-collapsesec0",user:"-user-",section:"-sec-"},k=function(){return j.course+d+j.user+e+j.lastSection},l=function(a){return j.course+d+j.section+a.toString()+j.user+e+j.content},m=function(a){return j.course+d+j.section+a.toString()+j.user+e+j.lastUpdated},n=function(){return j.course+d+j.user+e+j.collapseSecZero},o=function(){return j.userPrefStorage+j.user+e},p=function(a){return a.substring(0,4)===j.prefix&&a.substr(-12)===j.lastUpdated},q=function(a,b){var c;if(!b)return!1;try{return a===h.local?c=localStorage:a===h.session&&(c=sessionStorage),"undefined"!=typeof c&&(c.setItem("testItem","testValue"),"testValue"===c.getItem("testItem")&&(c.removeItem("testItem"),!0))}catch(d){return require(["core/log"],function(a){a.debug(d)}),!1}},r=function(a,b,c){if(void 0===b||void 0===a)throw"Missing section id";try{void 0!==c&&""!==c&&g.session&&i.userChoice===i.GIVEN?(sessionStorage.setItem(l(b),c),sessionStorage.setItem(m(b),Math.round(Date.now()/1e3).toString())):(sessionStorage.removeItem(l(b)),sessionStorage.removeItem(m(b)))}catch(d){require(["core/log"],function(a){a.debug(d)})}},s=function(a){var b=a.split("-");if(p(a))return{courseId:parseInt(b[2]),sectionId:parseInt(b[4]),userId:parseInt(b[6]),title:b[7]};throw new Error("Invalid lastUpdated key")},t=function(a,b,c){if(b)Object.keys(localStorage).filter(function(a){return a.substring(0,4)===j.prefix&&a!==o()}).forEach(function(a){localStorage.removeItem(a)}),Object.keys(sessionStorage).filter(function(a){return"mdl"===a.split("-")[0]}).forEach(function(a){if(p(a)){var b=s(a);r(b.courseId,b.sectionId,"")}});else{var d=Math.round(Date.now()/1e3)-60*a;Object.keys(sessionStorage).filter(function(a){return"mdl"===a.split("-")[0]}).forEach(function(b){if(p(b)){var c=s(b);(sessionStorage.getItem(b)<d||0===a)&&r(c.courseId,c.sectionId,"")}});var e=Object.keys(sessionStorage).filter(function(a){return p(a)});if(e.length>c){var f=e.map(function(a){return parseInt(sessionStorage[a])}).sort(),g=f[f.length-c];0===c&&(g=Date.now());var h;e.filter(function(a){return sessionStorage[a]<g}).forEach(function(a){h=s(a),r(h.courseId,h.sectionId,"")})}}},u=function(){b.get_strings([{key:"datapref",component:"format_tiles"},{key:"dataprefquestion",component:"format_tiles"},{key:"yes"},{key:"no"}]).done(function(a){c.confirm(a[0],a[1],a[2],a[3],function(){i.userChoice=i.GIVEN,localStorage.setItem(o(),i.GIVEN),g.local=q(h.local,f),g.session=q(h.session,f)},function(){i.userChoice=i.DENIED,localStorage.setItem(o(),i.DENIED),t(0,1,0),g.local=0})})},v=function(a){a&&g.local?localStorage.setItem(k(),a.toString()):localStorage.removeItem(k())},w={init:function(b,c,j,k,l,m,n){d=b.toString(),e=n.toString(),f=parseInt(c),i.userChoice=1===parseInt(m)?i.GIVEN:localStorage.getItem(o()),i.userChoice===i.DENIED?(g.local=!1,g.session=0,t(0,1,0)):(g.local=q(h.local,f),g.session=q(h.session,f)),a(document).ready(function(){1===m&&(i.userChoice=i.GIVEN),(g.local||g.session)&&null===i.userChoice&&setTimeout(function(){u()},500),a('a[href*="datapref"]').click(function(a){a.preventDefault(),u()}),j&&(v(k),t(0,1,0),g.session&&r(d,k,null)),a("#page-content").on("click",".tile",function(){setTimeout(function(){t(parseInt(l),0,f)},2e3)}),a('a.menu-action[data-title="switchroleto,moodle"]').click(function(){t(0,1,0)})})},storageEnabledSession:function(){return g.session},storageEnabledLocal:function(){return g.local},storageUserPreference:function(){return i.userChoice===i.GIVEN},getLastVisitedSection:function(){return localStorage.getItem(k())},getCourseContent:function(a,b){return sessionStorage.getItem(l(b))},getStoredContentAge:function(a,b){var c=parseInt(sessionStorage.getItem(m(b)));return!!c&&Math.round(Date.now()/1e3-c)},setSecZeroCollapseStatus:function(a){g.local&&i.userChoice===i.GIVEN&&("collapsed"===a?localStorage.removeItem(n()):localStorage.setItem(n(),"1"))},getSecZeroCollapseStatus:function(){return!!localStorage.getItem(n())},storeCourseContent:function(a,b,c){r(a,b,c)},cleanUpStorage:function(){t(0,1,1)},launchUserPreferenceWindow:function(){u()},setLastVisitedSection:function(a){i.userChoice===i.GIVEN&&v(a)}};return w});