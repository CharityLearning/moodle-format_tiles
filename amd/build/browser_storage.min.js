define(["jquery","core/str","core/notification"],function(a,b,c){"use strict";var d,e,f,g={local:!1,session:!1},h={GIVEN:"yes",DENIED:"no",userChoice:null},i={prefix:"mdl-",course:"mdl-course-",lastSection:"-lastSecId",content:"-content",lastUpdated:"-lastUpdated",userPrefStorage:"mdl-tiles-userPrefStorage",collapseSecZero:"-collapsesec0",user:"-user-"},j=function(){return i.course+d+i.lastSection},k=function(a){return i.course+d+"-sec-"+a.toString()+i.content},l=function(a){return i.course+d.toString()+"-sec-"+a.toString()+i.lastUpdated},m=function(){return i.course+d+i.user+e+i.collapseSecZero},n=function(a){return a.substring(0,4)===i.prefix&&a.substr(-12)===i.lastUpdated},o=function(a,b){var c;if(!b)return!1;try{return"local"===a?c=localStorage:"session"===a&&(c=sessionStorage),"undefined"!=typeof c&&(c.setItem("testItem","testValue"),"testValue"===c.getItem("testItem")&&(c.removeItem("testItem"),!0))}catch(d){return!1}},p=function(){return Object.keys(sessionStorage).filter(function(a){return n(a)}).length},q=function(a,b,c){c&&""!==c&&g.session?(sessionStorage.setItem(k(b),c),sessionStorage.setItem(l(b),Math.round(Date.now()/1e3).toString())):(sessionStorage.removeItem(k(b)),sessionStorage.removeItem(l(b)))},r=function(a){var b=a.split("-");if(n(a))return{courseId:parseInt(b[2]),sectionId:parseInt(b[4]),title:b[5]};throw new Error("Invalid lastUpdated key")},s=function(a,b,c){if(b&&(Object.keys(localStorage).filter(function(a){return a.substring(0,4)===i.prefix&&a!==i.userPrefStorage}).forEach(function(a){localStorage.removeItem(a)}),Object.keys(sessionStorage).filter(function(a){return"mdl"===a.split("-")[0]}).forEach(function(c){if(n(c)){var d=r(c);b?q(d.courseId,d.sectionId,null):(sessionStorage.getItem(c)<Math.round(Date.now()/1e3)-60*a||0===a)&&q(d.courseId,d.sectionId,null)}})),!b){var d=Object.keys(sessionStorage).filter(function(a){return n(a)});if(d.length>c){var e,f=d.map(function(a){return parseInt(sessionStorage[a])}).sort(),g=f[f.length-c];d.filter(function(a){return sessionStorage[a]<g}).forEach(function(a){e=r(a),q(e.courseId,e.sectionId,null)})}}},t=function(){b.get_strings([{key:"datapref",component:"format_tiles"},{key:"dataprefquestion",component:"format_tiles"},{key:"yes"},{key:"no"}]).done(function(a){c.confirm(a[0],a[1],a[2],a[3],function(){h.userChoice=h.GIVEN,localStorage.setItem(i.userPrefStorage,h.GIVEN),g.local=o("local",f),g.session=o("session",f)},function(){h.userChoice=h.DENIED,localStorage.setItem(i.userPrefStorage,h.DENIED),s(0,1,0),g.local=0})})},u=function(a){a&&g.local?localStorage.setItem(j(),a.toString()):localStorage.removeItem(j())},v={init:function(b,c,j,k,l,m,n){d=b.toString(),e=n.toString(),f=c,h.userChoice=1===m?h.GIVEN:localStorage.getItem(i.userPrefStorage),h.userChoice===h.DENIED?(g.local=!1,g.session=0,s(0,1,0)):(g.local=o("local",f),g.session=o("session",f)),a(document).ready(function(){"1"===m&&(h.userChoice=h.GIVEN),(g.local||g.session)&&null===h.userChoice&&setTimeout(function(){t(c)},500),a('a[href*="datapref"]').click(function(a){a.preventDefault(),t(c)}),a("#page").on("click",".togglecompletion",function(b){if(g.local){q(d,0,null);var c=a(b.currentTarget).attr("data-section");setTimeout(function(){q(d,c,a("#section-"+c).html())},1e3)}}),j&&(u(k),s(0,1,0),g.session&&q(d,k,null)),a("#page-content").on("click",".tile",function(){g.session&&p()>c&&setTimeout(function(){s(l,0,c)},2e3)})})},storageEnabledSession:function(){return g.session},storageEnabledLocal:function(){return g.local},storageUserPreference:function(){return h.userChoice===h.GIVEN},getLastVisitedSection:function(){return localStorage.getItem(j())},getCourseContent:function(a,b){return sessionStorage.getItem(k(b))},getStoredContentAge:function(a,b){var c=parseInt(sessionStorage.getItem(l(b)));return!!c&&Math.round(Date.now()/1e3-c)},setSecZeroCollapseStatus:function(a){g.local&&h.userChoice===h.GIVEN&&("collapsed"===a?localStorage.removeItem(m()):localStorage.setItem(m(),"1"))},getSecZeroCollapseStatus:function(){return!!localStorage.getItem(m())},storeCourseContent:function(a,b,c){h.userChoice===h.GIVEN&&q(a,b,c)},cleanUp:function(a,b,c){s(a,b,c)},launchUserPreferenceWindow:function(){t()},setLastVisitedSection:function(a){h.userChoice===h.GIVEN&&u(a)}};return v});