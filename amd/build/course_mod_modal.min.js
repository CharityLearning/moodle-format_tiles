define(["jquery","core/modal_factory","core/config","core/templates","core/notification","core/ajax"],function(a,b,c,d,e,f){"use strict";var g,h={},i=a(window),j=0,k={launchResourceModal:'[data-action="launch-tiles-resource-modal"]',launchModuleModal:'[data-action="launch-tiles-module-modal"]',toggleCompletion:".togglecompletion",modal:".modal-dialog",sectionMain:".section.main",pageContent:"#page-content",completionState:"#completionstate_"},l=function(){if(0!==j)return j;var a=i.width();return a>=900?900:a>=500?a-65:a},m=function(f){var j=f.attr("data-cmid");return b.create({type:b.types.DEFAULT,title:f.attr("data-title"),body:g}).done(function(b){h[j]=b,b.setLarge(),b.show();var g=a(b.root);g.attr("id","embed_mod_modal_"+j),g.addClass("embed_cm_modal");var m={id:j,pluginfileUrl:f.attr("data-url"),filetype:"pdf",width:l(),height:Math.round(i.height()-60),cmid:j,tileid:f.closest(k.sectionMain).attr("data-section"),isediting:0,sesskey:c.sesskey,modtitle:f.attr("data-title"),config:{wwwroot:c.wwwroot}};if(0!==f.find(k.toggleCompletion).length){var n=parseInt(a(k.completionState+j).attr("value"));m.completionInUseForCm=1,m.completionstate=1-n,m.completionstateInverse=n,m.completionIsManual=f.find(k.toggleCompletion).attr("data-ismanual")}else m.completionInUseForCm=0;return d.render("format_tiles/embed_file_modal_body",m).done(function(a){b.setBody(a),g.find(k.modal).animate({"max-width":Math.round(1.1*l())},"fast")}).fail(e.exception),!0}),!1},n=function(i,j){var m=i.attr("data-cmid"),n="format_tiles_get_mod_"+i.attr("data-modtype")+"_html";return b.create({type:b.types.DEFAULT,title:i.attr("data-title"),body:g}).done(function(b){h[m]=b,b.setLarge(),b.show();var g=a(b.root);g.attr("id","embed_mod_modal_"+m),g.addClass("embed_cm_modal"),g.addClass(i.attr("data-modtype")),f.call([{methodname:n,args:{courseid:j,cmid:m}}])[0].done(function(c){var f={cmid:m,content:c.html};if(0!==i.find(k.toggleCompletion).length){var h=parseInt(a(k.completionState+m).attr("value"));f.completionInUseForCm=1,f.completionstate=1-h,f.completionstateInverse=h,f.completionIsManual=i.find(k.toggleCompletion).attr("data-ismanual")}else f.completionInUseForCm=0;return d.render("format_tiles/embed_activity_modal_body",f).done(function(a){b.setBody(a),g.find(k.modal).animate({"max-width":Math.round(1.1*l())},"fast")}).fail(e.exception),!0}).fail(function(a){c.developerdebug!==!0?window.location=c.wwwroot+"/mod/"+i.attr("data-modtype")+"/view.php?id="+m:e.exception(a)})}),!1};return{init:function(b){a(document).ready(function(){a(k.pageContent).on("click",k.launchResourceModal,function(c){c.preventDefault();var d=a(c.currentTarget).closest("li.activity"),g=h[d.attr("data-cmid")];"object"==typeof g?g.show():(m(d),f.call([{methodname:"format_tiles_log_mod_view",args:{courseid:b,cmid:d.attr("data-cmid")}}])[0].fail(e.exception))}),a(k.pageContent).on("click",k.launchModuleModal,function(c){c.preventDefault();var d=a(c.currentTarget).closest("li.activity"),g=h[d.attr("data-cmid")];return"object"==typeof g?g.show():(n(d,b),f.call([{methodname:"format_tiles_log_mod_view",args:{courseid:b,cmid:d.attr("data-cmid")}}])[0].fail(e.exception)),!1}),d.render("format_tiles/loading",{})["catch"](e.exception).done(function(a){g=a}).fail(e.exception)})}}});