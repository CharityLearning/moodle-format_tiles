define(["jquery","core/modal_factory","core/config","core/templates","core/notification","core/ajax"],function(a,b,c,d,e,f){"use strict";var g,h={},i=a(window),j={toggleCompletion:".togglecompletion",modal:".modal",modalDialog:".modal-dialog",modalBody:".modal-body",sectionMain:".section.main",pageContent:"#page-content",regionMain:"#region-main",completionState:"#completionstate_",cmModalClose:".embed_cm_modal .close",cmModal:".embed_cm_modal",modalClearOnDismissButton:".clear-on-dismiss button.close",moodleMediaPlayer:".mediaplugin_videojs",urlModalLoadWarning:"#embed-url-error-msg-"},k={launchResourceModal:"launch-tiles-resource-modal",launchModuleModal:"launch-tiles-module-modal",launchUrlModal:"launch-tiles-url-modal"},l={modalClearOnDismiss:"clear-on-dismiss"},m=function(){return Math.min(i.width(),900)},n=function(f){var k=f.attr("data-cmid");return b.create({type:b.types.DEFAULT,title:f.attr("data-title"),body:g}).done(function(b){h[k]=b,b.setLarge(),b.show();var g=a(b.root);g.attr("id","embed_mod_modal_"+k),g.attr("data-cmid",k),g.addClass("embed_cm_modal");var n={id:k,pluginfileUrl:f.attr("data-url"),objectType:"text/html",width:"100%",height:Math.round(i.height()-60),cmid:k,tileid:f.closest(j.sectionMain).attr("data-section"),isediting:0,sesskey:c.sesskey,modtitle:f.attr("data-title"),config:{wwwroot:c.wwwroot},showDownload:0,showNewWindow:0,completionInUseForCm:0};if("resource_pdf"===f.attr("data-modtype")&&(n.objectType="application/pdf",n.showDownload=1,n.showNewWindow=1),d.render("format_tiles/embed_file_modal_body",n).done(function(a){b.setBody(a),g.find(j.modalBody).animate({"min-height":Math.round(i.height()-60)},"fast"),"resource_html"===f.attr("data-modtype")?(g.find(j.modal).animate({"max-width":"100%"},"fast"),g.find(j.modalDialog).animate({"max-width":"100%"},"fast"),g.find(j.modalBody).animate({"max-width":"100%"},"fast"),g.addClass(l.modalClearOnDismiss)):(g.find(j.modal).animate({"max-width":m()},"fast"),g.find(j.modalDialog).animate({"max-width":m()},"fast"))}).fail(e.exception),0!==f.find(j.toggleCompletion).length){var o=parseInt(a(j.completionState+k).attr("value"));n.completionInUseForCm=1,n.completionstate=1-o,n.completionicon=1===o?"n":"y",n.completionstateInverse=o,n.completionIsManual=f.find(j.toggleCompletion).attr("data-ismanual")}return d.render("format_tiles/embed_module_modal_header",n).done(function(a){b.setTitle(a)}).fail(e.exception),!0}),!1},o=function(f){var k=f.attr("data-cmid");return b.create({type:b.types.DEFAULT,title:f.attr("data-title"),body:g}).done(function(b){h[k]=b,b.setLarge(),b.show();var g=a(b.root);g.attr("id","embed_mod_modal_"+k),g.attr("data-cmid",k),g.addClass("embed_cm_modal");var m=Math.round(.9*i.width()),n=Math.round(.9*i.height()),o={id:k,pluginfileUrl:f.attr("data-url"),objectType:"text/html",width:m-30,height:n-30,cmid:k,tileid:f.closest(j.sectionMain).attr("data-section"),isediting:0,sesskey:c.sesskey,modtitle:f.attr("data-title"),config:{wwwroot:c.wwwroot},showDownload:0,showNewWindow:1,completionInUseForCm:0};if(d.render("format_tiles/embed_url_modal_body",o).done(function(a){b.setBody(a),g.find(j.modalBody).animate({"min-height":n},"fast"),g.find(j.modal).animate({"max-width":m},"fast"),g.find(j.modalDialog).animate({"max-width":m},"fast"),g.find(j.modalBody).animate({"max-width":m},"fast"),g.addClass(l.modalClearOnDismiss),g.find(j.modalBody).addClass("text-center")}).fail(e.exception),0!==f.find(j.toggleCompletion).length){var p=parseInt(a(j.completionState+k).attr("value"));o.completionInUseForCm=1,o.completionstate=1-p,o.completionicon=1===p?"n":"y",o.completionstateInverse=p,o.completionIsManual=f.find(j.toggleCompletion).attr("data-ismanual")}return d.render("format_tiles/embed_module_modal_header",o).done(function(a){b.setTitle(a)}).fail(e.exception),!0}),!1},p=function(b){b.find(j.modal).animate({"max-width":m()},"fast");var c=70,d=a(j.moodleMediaPlayer);d.find("div").each(function(b,c){a(c).css("max-width","")}),d.closest(j.cmModal).addClass(l.modalClearOnDismiss),b.find("iframe").each(function(d,e){var f;f=b.find(j.modalDialog),0===f.length&&(f=b.find(j.modal));var g=Math.min(a(e).width(),i.width());g>f.width()-c&&(f.animate({"max-width":Math.max(g+c,m())},"fast"),b.find(j.modal).animate({"max-width":Math.max(g+c,m())},"fast"));var h=Math.min(a(e).height(),i.height()),k=b.find(j.modalBody);h>k.height()-c&&k.animate({"min-height":Math.min(h+c,i.height())},"fast"),k.css("text-align","center"),b.addClass(l.modalClearOnDismiss)})},q=function(i,k){var l=i.attr("data-cmid"),m="format_tiles_get_mod_"+i.attr("data-modtype")+"_html";return b.create({type:b.types.DEFAULT,title:i.attr("data-title"),body:g}).done(function(b){h[l]=b,b.setLarge(),b.show();var g=a(b.root);g.attr("data-cmid",l),g.attr("id","embed_mod_modal_"+l),g.addClass("embed_cm_modal"),g.addClass(i.attr("data-modtype")),f.call([{methodname:m,args:{courseid:k,cmid:l}}])[0].done(function(c){var f={cmid:l,modtitle:i.attr("data-title"),content:c.html};if(0!==i.find(j.toggleCompletion).length){var h=parseInt(a(j.completionState+l).attr("value"));f.completionInUseForCm=1,f.completionstate=1-h,f.completionstateInverse=h,f.completionIsManual=i.find(j.toggleCompletion).attr("data-ismanual"),f.completionicon=1===h?"n":"y"}else f.completionInUseForCm=0;return b.setBody(f.content),d.render("format_tiles/embed_module_modal_header",f).done(function(a){b.setTitle(a)}).fail(e.exception),p(g),!0}).fail(function(a){c.developerdebug!==!0?window.location=c.wwwroot+"/mod/"+i.attr("data-modtype")+"/view.php?id="+l:e.exception(a)})}),!1};return{init:function(b){a(document).ready(function(){var c=Object.keys(k).map(function(a){return'[data-action="'+k[a]+'"]'}).join(", "),i=a(j.pageContent);0===i.length&&(i=a(j.regionMain)),i.on("click",c,function(c){c.preventDefault();var d=a(c.currentTarget),g=d.closest("li.activity"),i=h[g.attr("data-cmid")];if("object"==typeof i)i.show();else{switch(d.attr("data-action")){case k.launchModuleModal:q(g,b);break;case k.launchResourceModal:n(g,b);break;case k.launchUrlModal:o(g,b);break;default:throw new Error("Unknown modal type "+d.attr("data-action"))}f.call([{methodname:"format_tiles_log_mod_view",args:{courseid:b,cmid:g.attr("data-cmid")}}])[0].fail(e.exception)}}),a("body").on("click",j.modalClearOnDismissButton,function(b){var c=a(b.currentTarget).closest(j.cmModal).attr("data-cmid");a(b.currentTarget).closest(j.cmModal).find(j.modalBody).empty(),h[c]=void 0}),d.render("format_tiles/loading",{})["catch"](e.exception).done(function(a){g=a}).fail(e.exception)})}}});