define(["jquery","core/templates","core/ajax","core/str","core/notification","core/config"],function(a,b,c,d,e,f){"use strict";var g,h={pickAnIcon:""},i=[],j=[],k=function(b,d){var e=c.call([{methodname:"format_tiles_get_icon_set",args:{courseid:b}}]);e[0].done(function(b){b.photos&&(j=JSON.parse(b.photos));var c=JSON.parse(b.icons);Object.keys(c).forEach(function(a){i.push({filename:a,displayname:c[a]})}),"function"==typeof d&&d();var e=j.map(function(a){return a.filename});a("#iconpickerphotos").find(".photo").each(function(b,c){c=a(c),e.indexOf(c.attr("data-filename"))===-1&&c.fadeOut(500)})}),e[0].fail(function(a){require(["core/log"],function(b){b.debug(a)})})},l=function(a,b){return f.wwwroot+"/course/format/tiles/editimage.php?courseid="+a+"&sectionid="+b},m=function(f,g,h,i,j,m,n,o,p){var q={image:h,courseid:m,sectionid:f,imagetype:n,sourcecontextid:void 0===o?0:o,sourceitemid:void 0===p?0:p},r=c.call([{methodname:"format_tiles_set_image",args:q}]);r[0].done(function(c){if(c.status===!0)if("course-view-tiles"===j){var o=a("#tileicon_"+g),p="",q={tileicon:h,tileid:g,secid:f,isediting:1};switch(n){case"tileicon":p="tileicon";break;case"tilephoto":p="tilebarphoto",q.phototileurl=c.imageurl,q.phototileediturl=l(m,f),q.iamgetype=c.imagetype,o.closest(".tileiconcontainer").addClass("hasphoto"),setTimeout(function(){k(m)},3e3);break;case"draftfile":p="tilebarphoto",q.phototileurl=c.imageurl,q.phototileediturl=l(m,f),q.iamgetype=c.imagetype;break;default:throw new Error("Invalid image type "+n)}o.animate({opacity:0},500,function(){b.render("format_tiles/"+p,q).done(function(a){o.html(a).animate({opacity:1},500)})})}else if("course-edit"===j||"course-editsection"===j){var r=a("#id_defaulttileicon");"course-editsection"===j&&(r=a("#id_tileicon")),r.val(h),b.renderPix("tileicon/"+h,"format_tiles",i).done(function(b){a("#selectedicon").html(b),"course-editsection"===j&&d.get_strings([{key:"tip",component:"format_tiles"},{key:"tileselecttip",component:"format_tiles"}]).done(function(a){e.alert(a[0],a[1])})})}}).fail(function(a){require(["core/log"],function(b){b.debug(a)})})},n=function(c,d,e,k,n,o){var p=function(b,e,f){var g=a("#iconpickerphotos");g.html(b);var h=2e5,i=[];g.find("img").each(function(b,g){g=a(g),g.attr("data-filesize")<h?setTimeout(function(){g.attr("src",g.attr("data-url"))},20*b):i.push(g),g.click(function(b){var g=a(b.currentTarget);m(e.attr("data-sectionid"),e.attr("data-section"),g.attr("data-filename"),g.attr("data-filename"),c,d,g.attr("data-imagetype"),g.attr("data-contextid"),g.attr("data-itemid")),f.hide()})}),setTimeout(function(){i.forEach(function(a){a.attr("src",a.attr("data-url"))})},1e3)};if("object"!=typeof g)b.render("format_tiles/icon_picker_modal_body",{icon_picker_icons:i,photosallowed:n,wwwroot:f.wwwroot,documentationurl:o}).done(function(i){require(["core/modal_factory"],function(o){o.create({type:o.types.DEFAULT,title:h.pickAnIcon,body:i}).done(function(h){g=h,h.setLarge(),h.show();var i=a(h.root);if(i.attr("id","icon_picker_modal"),i.attr("data-sectionid",e),i.attr("data-section",k),i.addClass("icon_picker_modal"),i.on("click",".pickericon",function(b){var f=a(b.currentTarget);m(e,k,f.attr("data-icon"),f.attr("title"),c,d,"tileicon",f.attr("data-contextid"),f.attr("data-itemid")),h.hide()}),i.on("input","input.iconsearch",function(b){var c=b.currentTarget.value.toLowerCase();i.find(".pickericon").show(),c.length>=3&&i.find(".pickericon").filter(function(b,d){return a(d).attr("data-original-title").toLowerCase().indexOf(c)<0}).hide()}),a(".pickericon").tooltip(),n){var o=l(d,e);i.find("#phototilebtn").attr("href",o),a("#launch-photo-library").click(function(){0!==j.length&&b.render("format_tiles/icon_picker_photos",{icon_picker_photos:j,wwwroot:f.wwwroot}).done(function(a){p(a,i,h)})})}})})});else{if(g.root.attr("data-sectionid",e),g.root.attr("data-section",k),g.root.off("click"),g.root.on("click",".pickericon",function(b){var f=a(b.currentTarget);m(e,k,f.attr("data-icon"),f.attr("title"),c,d,f.attr("data-imagetype"),f.attr("data-contextid"),f.attr("data-itemid")),g.hide()}),n){var q=l(d,e);g.root.find("#phototilebtn").attr("href",q)}g.show()}};return{init:function(b,c,e,f){a(document).ready(function(){var g=e?"picknewiconphoto":"picknewicon";d.get_string(g,"format_tiles").done(function(a){h.pickAnIcon=a}),k(b);var i=a("#page-content");0===i.length&&(i=a("#region-main")),i.on("click",".launchiconpicker",function(d){d.preventDefault();var g=a(d.currentTarget);n(c,b,g.attr("data-sectionid"),g.attr("data-section"),"1"===e,f)})})}}});